## 10.  Java线程（中）：创建多少线程才是合适的？

### 为什么要使用多线程？

      所谓提升性能，从度量的角度，主要是降低延迟，提高吞吐量
      
   1. 将方法中能够并行的操作使用多线程异步处理减少方法的执行时间（延迟降低，提升吞吐）
   2. 使用多线程将单机性能发挥到极致（延迟不变，提升吞吐）
   3. 单机性能瓶颈时集群部署（提升吞吐，延迟不变）

###  针对不同场景的线程设置（以下设置是在cup和io交替运行，且单个cpu和io耗时服务优化的情况下）

- 纯cup计算

      理论上“设置线程的数量=CPU核数”，不过在工程上，线程的数量一般会设置为“CPU核数+1”
    
    如图：

   ![](http://gitimg.zhaozhubao.com/gitimg/20190519181444.png)


- CPU计算和I/O操作的耗时是1:1

      2个线程是最合适的，当一个线程执行cup计算时，另外一个线程可以执行io操作，虽然对于当个请求线程的时延没有减少
      但吞吐量却上去了，比如之前吞吐是4 个/s，使用两个线程的吞吐为8 个/s
      
    如图：
    
   ![](http://gitimg.zhaozhubao.com/gitimg/微信截图_20190519183954.png)
    
    > 示例：Test1

- CPU计算和I/O操作的耗时是1:2

      在io不存在不存在瓶颈的情况下（如有独立的文件服务器，可用同时执行多个文件的读写操作），3个线程是最合适的，计算公式为：最佳线程数=1 +（I/O耗时 / CPU耗时），如果是多核，还需乘cpu核数
      
     ![](http://gitimg.zhaozhubao.com/gitimg/微信截图_20190520101651.png)
     
     > 示例：Test2
    

